#pragma checksum "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\Pages\PowerProfile\PowerProfileChart.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "7caf70d0dc40aa493b638b53485f5f5b6406d631"
// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace SmartWattsUi.Pages.PowerProfile
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using SmartWattsUi;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\_Imports.razor"
using SmartWattsUi.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\Pages\PowerProfile\PowerProfileChart.razor"
using SmartWattsCore.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\Pages\PowerProfile\PowerProfileChart.razor"
using SmartWattsUi.Controllers;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\Pages\PowerProfile\PowerProfileChart.razor"
using SmartWattsCore;

#line default
#line hidden
#nullable disable
    public partial class PowerProfileChart : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 82 "C:\Users\Rhys\source\repos\SmartWatts\SmartWattsUi\Pages\PowerProfile\PowerProfileChart.razor"
       
	[Parameter]
	public List<Ride> Rides { get; set; }

	[Parameter]
	public int LookBack { get; set; }

	List<Ride> displayRides = new List<Ride>();
	IEnumerable<int> improvments;

	Dictionary<int, int> PowerHistory30 = new Dictionary<int, int>();
	Dictionary<int, int> PowerHistory90 = new Dictionary<int, int>();
	Dictionary<int, int> PowerHistory365 = new Dictionary<int, int>();
	Dictionary<int, int> PowerHistoryAll = new Dictionary<int, int>();
	List<int> powerPoints;

	protected override void OnInitialized()
	{
		if (_appState.LoggedInUser == null)
		{
			NavigationManager.NavigateTo("splash");
		}
		else
		{
			FindImprovments();
			RemoveRides();
			GetPowerHistories();
		}
	}

	private void RemoveRides()
	{
		var latestDate = Rides.Max(r => r.RideMetaData.Date);
		displayRides = Rides.Where(r => r.RideMetaData.Date <= latestDate.AddDays(-LookBack)).ToList();
	}

	private void FindImprovments()
	{
		var changes = new List<int>();

		var currentPH = _powerProfileController.GetPowerCurveHistory(Rides, DateTime.Now, 30);
		powerPoints = currentPH.Keys.ToList();
		var latestDate = Rides.Max(r => r.RideMetaData.Date);
		var previousPH = _powerProfileController.GetPowerCurveHistory(Rides,latestDate.AddMinutes(-1), 30);

		improvments = powerPoints.Where(pp => currentPH[pp] > previousPH[pp]);
	}

	private void GetPowerHistories()
	{
		PowerHistory30 = _powerProfileController.GetPowerCurveHistory(displayRides, DateTime.Now, 30);
		PowerHistory90 = _powerProfileController.GetPowerCurveHistory(displayRides, DateTime.Now, 90);
		PowerHistory365 = _powerProfileController.GetPowerCurveHistory(displayRides, DateTime.Now, 365);
		PowerHistoryAll = _powerProfileController.GetPowerCurveHistory(displayRides, DateTime.Now, 9999);
	}

	private string GetPercentageOff(int powerPoint, Dictionary<int, int> powerHistoryOld, Dictionary<int, int> powerHistoryNew)
	{
		var newValue = powerHistoryNew.FirstOrDefault(ph => ph.Key == powerPoint).Value;
		var oldValue = powerHistoryOld.FirstOrDefault(ph => ph.Key == powerPoint).Value;

		var diff = (((float)newValue / oldValue) - 1) * 100;

		if (oldValue == 0)
		{
			return "0.0";
		}

		return (Math.Abs(diff)).ToString("0.0");
	}

	private string GetColor(string powerDiff)
	{
		var power = float.Parse(powerDiff);

		if (power < .1)
		{
			return "green";
		}
		else if (power >= .1 && power <= 5.0)
		{
			return "yellow";
		}
		else if (power > 5.0 && power <= 10.0)
		{
			return "orange";
		}
		else
		{
			return "red";
		}
	}


#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private PowerProfileController _powerProfileController { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AppState _appState { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager NavigationManager { get; set; }
    }
}
#pragma warning restore 1591
